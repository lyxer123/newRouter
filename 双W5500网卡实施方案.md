# 双W5500网卡实施方案

## 一、ESP32S3硬件资源分析

### 1.1 ESP32S3规格参数

**CPU性能**：
- **处理器**：Xtensa® 32位 LX7 双核
- **主频**：最高240MHz（可调）
- **架构**：支持双核运行，当前配置为单核模式（`CONFIG_ESP_SYSTEM_SINGLE_CORE_MODE=y`）

**内存资源**：
- **片上SRAM**：512KB
- **ROM**：384KB
- **外部Flash**：当前配置4MB（`CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y`）
- **外部PSRAM**：可选，某些开发板支持8MB PSRAM

**GPIO资源**：
- **总GPIO数**：48个（ESP32S3）
- **可用于SPI的GPIO**：充足，支持多个SPI设备

**SPI性能**：
- **SPI速度**：最高80MHz（当前配置：`CONFIG_BRIDGE_ETH_SPI_CLOCK_MHZ=16`，可提升）
- **SPI模式**：支持DMA传输

### 1.2 内存使用分析

**单W5500内存占用估算**：
- **驱动层**：~6.5KB
- **网络栈**：~4KB（基础）
- **DMA缓冲区**：~10KB（假设6个缓冲区）
- **NAPT表**：~33KB
- **TCP缓冲区**：~11.5KB（假设2个TCP连接）
- **总计**：~65KB

**双W5500内存占用估算**：
- **单W5500**：~65KB
- **第二个W5500**：~20.5KB（驱动+接口+缓冲区）
- **网络监控任务**：~4KB（新增）
- **路由管理**：~2KB（新增）
- **总计**：~91.5KB

**系统总内存占用估算**：
- **双W5500**：~91.5KB
- **LWIP协议栈**：~60KB（不含WiFi）
- **WiFi驱动**：~30KB（如果启用WiFi）
- **FreeRTOS**：~10KB
- **应用程序**：~39KB
- **总计**：~230KB（不含WiFi）或 ~260KB（含WiFi）

**内存可用性评估**：
- **总SRAM**：512KB
- **系统保留**：~50KB（启动代码、中断向量等）
- **可用SRAM**：~462KB
- **已使用**：~230-260KB
- **剩余**：~200-230KB
- **使用率**：~50-56%

**结论**：✅ **内存充足，可以实现双W5500**

---

## 二、双W5500网卡角色分配策略

### 2.1 更新的方案

根据新的需求，方案已从**固定角色分配**更新为**卡1可WAN可LAN，卡2固定LAN**。

**新方案**：
- **卡1**：可WAN可LAN（自动切换）
  - 连接上级路由器时自动作为WAN
  - 连接下位设备时自动作为LAN
  - 启用"Ethernet acts as WAN or LAN automatically"功能
- **卡2**：固定为LAN（连接下位计算机）
  - 始终作为数据转发接口
  - 始终启用DHCP服务器
  - 不参与自动切换

### 2.2 路由优先级策略

- **卡1作为WAN时**：卡1(WAN) > 4G > 卡2(LAN)
- **卡1作为LAN时**：4G > 卡1(LAN) > 卡2(LAN)

---

## 三、SPI方案选择

### 3.1 方案确定：分离SPI方案

**硬件连接配置**：
- **卡1（W5500 Card 1）**：
  - SCK = GPIO9
  - MOSI = GPIO3
  - MISO = GPIO46
  - CS0 = GPIO10
  - INT = GPIO12
  - RESET = GPIO38

- **卡2（W5500 Card 2）**：
  - SCK = GPIO9
  - MOSI = GPIO3
  - MISO = GPIO46
  - CS1 = GPIO11
  - INT = GPIO13
  - RESET = GPIO34

**方案特点**：
- ✅ 两个W5500使用独立的SPI总线（SPI2和SPI3）
- ✅ 每个设备有独立的控制信号
- ✅ GPIO资源需求：12个（每个SPI 6个）
- ✅ 软件无需总线仲裁机制
- ✅ 并行通信，性能优秀

### 3.2 性能预期

**分离SPI方案性能**：
- **总带宽**：60-100Mbps
- **延迟**：< 10ms（轻负载）
- **并发能力**：优秀（并行传输）

**适用场景**：
- ✅ GPIO资源充足的情况
- ✅ 对性能要求较高的场景
- ✅ 需要并行通信的应用

---

## 四、需求分析

### 4.1 功能需求

1. **保留现有功能**：4G转WiFi功能保持不变
2. **新增W5500卡2**：
   - **采用方案**：与卡1使用分离SPI总线
   - **硬件连接**：如上所述
3. **角色分配策略**：
   - **W5500卡1**：可WAN可LAN（自动切换）
     - 连接上级路由器时自动作为WAN
     - 连接下位设备时自动作为LAN
     - 启用"Ethernet acts as WAN or LAN automatically"功能
   - **W5500卡2**：固定作为LAN（连接下位计算机）
     - 始终作为数据转发接口
     - 始终启用DHCP服务器
     - 不参与自动切换
   - **WiFi Station**：可作为WAN（连接上级路由器）
     - 启用"Use Wi-Fi station interface to connect to the external network"功能
   - **4G模块**：作为WAN（备用连接）
4. **智能路由切换**：
   - **当卡1作为WAN时**：优先使用卡1有线网络，卡1断线时切换到WiFi Station，WiFi Station断线时切换到4G
   - **当卡1作为LAN时**：优先使用4G网络，4G断线时使用WiFi Station，WiFi Station断线时使用卡1
   - **卡2始终为下位计算机分配IP**（DHCP服务器）

### 4.2 技术难点

1. **硬件层面**（分离SPI方案）：
   - 两个W5500使用独立的SPI总线（SPI2和SPI3）
   - 需要独立的CS、INT、RST信号
   - ESP-IDF SPI驱动无需处理总线仲裁
   - **特点**：并行通信，性能优秀，无总线竞争

2. **软件层面**：
   - 需要创建两个独立的网络接口
   - 卡1需要支持自动WAN/LAN切换
   - 卡2固定为LAN模式
   - WiFi Station需要支持WAN模式
   - 需要实现路由优先级管理
   - 需要实现网络状态监控和动态切换
   - 需要实现DHCP服务器功能（卡2，以及卡1作为LAN时）

3. **路由层面**：
   - 动态路由优先级管理：
     - 卡1作为WAN时：卡1 > WiFi Station > 4G > 卡2
     - 卡1作为LAN时：4G > WiFi Station > 卡1 > 卡2
   - 实现链路状态检测
   - 实现路由表的动态更新
   - 处理卡1角色切换时的路由更新

---

## 五、代码结构分析

### 5.1 现有代码结构
- **bridge_eth.c**：以太网接口创建和管理
- **bridge_common.c**：网络接口通用管理，包括DHCP、DNS、路由等
- **bridge_spi.c**：SPI网络接口管理
- **bridge_modem.c**：4G模块管理
- **bridge_wifi.c**：WiFi接口管理
- **Kconfig**：配置文件，定义各种编译选项

### 5.2 关键配置项

**分离SPI方案配置**：
- `CONFIG_BRIDGE_ETH_SPI_HOST_CARD1`：SPI2主机
- `CONFIG_BRIDGE_ETH_SPI_SCLK_CARD1_GPIO`：卡1 SCK引脚（GPIO12）
- `CONFIG_BRIDGE_ETH_SPI_MOSI_CARD1_GPIO`：卡1 MOSI引脚（GPIO11）
- `CONFIG_BRIDGE_ETH_SPI_MISO_CARD1_GPIO`：卡1 MISO引脚（GPIO13）
- `CONFIG_BRIDGE_ETH_SPI_CS0_CARD1_GPIO`：卡1 CS引脚（GPIO10）
- `CONFIG_BRIDGE_ETH_SPI_INT0_CARD1_GPIO`：卡1 INT引脚（GPIO12）
- `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_CARD1_GPIO`：卡1 RST引脚（GPIO38）
- `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0_CARD1`：卡1 PHY地址（默认0）

- `CONFIG_BRIDGE_ETH_SPI_HOST_CARD2`：SPI3主机
- `CONFIG_BRIDGE_ETH_SPI_SCLK_CARD2_GPIO`：卡2 SCK引脚（GPIO47）
- `CONFIG_BRIDGE_ETH_SPI_MOSI_CARD2_GPIO`：卡2 MOSI引脚（GPIO21）
- `CONFIG_BRIDGE_ETH_SPI_MISO_CARD2_GPIO`：卡2 MISO引脚（GPIO19）
- `CONFIG_BRIDGE_ETH_SPI_CS0_CARD2_GPIO`：卡2 CS引脚（GPIO20）
- `CONFIG_BRIDGE_ETH_SPI_INT0_CARD2_GPIO`：卡2 INT引脚（GPIO14）
- `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_CARD2_GPIO`：卡2 RST引脚（GPIO48）
- `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0_CARD2`：卡2 PHY地址（默认1）

**网络配置**：
- `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN`：自动WAN/LAN切换（卡1启用）
- `CONFIG_BRIDGE_EXTERNAL_NETIF_STATION`：WiFi Station作为WAN（可选）
- `CONFIG_BRIDGE_EXTERNAL_NETIF_ETHERNET`：以太网作为WAN（可选，用于卡1）
- `CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET`：以太网作为LAN（卡2固定）

**路由优先级**：
- WAN接口：`route_prio = 50`（较高优先级）
- LAN接口：`route_prio = 10`（较低优先级）
- 4G接口：需要查看具体配置

---

## 六、实施方案步骤

### 步骤1：硬件配置扩展（分离SPI方案）
**目标**：在Kconfig中添加W5500卡2的GPIO配置项（分离SPI总线）

**实现内容**（分离SPI方案）：
1. 在`Kconfig`中确认卡1的SPI配置项（分离总线）：
   - `CONFIG_BRIDGE_ETH_SPI_HOST_CARD1`：SPI2主机
   - `CONFIG_BRIDGE_ETH_SPI_SCLK_CARD1_GPIO`：SCK引脚（GPIO12）
   - `CONFIG_BRIDGE_ETH_SPI_MOSI_CARD1_GPIO`：MOSI引脚（GPIO11）
   - `CONFIG_BRIDGE_ETH_SPI_MISO_CARD1_GPIO`：MISO引脚（GPIO13）
   - `CONFIG_BRIDGE_ETH_SPI_CS0_CARD1_GPIO`：卡1的CS引脚（GPIO10）
   - `CONFIG_BRIDGE_ETH_SPI_INT0_CARD1_GPIO`：卡1的INT引脚（GPIO12）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_CARD1_GPIO`：卡1的RST引脚（GPIO38）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0_CARD1`：卡1的PHY地址（默认0）

2. 在`Kconfig`中添加卡2的配置项（分离SPI总线）：
   - `CONFIG_BRIDGE_ETH_SPI_HOST_CARD2`：SPI3主机
   - `CONFIG_BRIDGE_ETH_SPI_SCLK_CARD2_GPIO`：SCK引脚（GPIO47）
   - `CONFIG_BRIDGE_ETH_SPI_MOSI_CARD2_GPIO`：MOSI引脚（GPIO21）
   - `CONFIG_BRIDGE_ETH_SPI_MISO_CARD2_GPIO`：MISO引脚（GPIO19）
   - `CONFIG_BRIDGE_ETH_SPI_CS0_CARD2_GPIO`：卡2的CS引脚（GPIO20）
   - `CONFIG_BRIDGE_ETH_SPI_INT0_CARD2_GPIO`：卡2的INT引脚（GPIO14）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_CARD2_GPIO`：卡2的RST引脚（GPIO48）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0_CARD2`：卡2的PHY地址（默认1）

### 步骤2：扩展W5500初始化函数
**目标**：修改`bridge_eth.c`，支持初始化第二个W5500（分离SPI总线）

**实现内容**（分离SPI方案）：
1. 修改`esp_spi_eth_new_w5500`函数，支持设备索引参数（card_index）
2. 修改`esp_bridge_eth_spi_init`函数，支持初始化多个W5500设备（分离SPI总线）
3. 为每个W5500设备创建独立的`eth_handle`
4. 确保每个SPI总线独立初始化
5. ESP-IDF SPI驱动无需处理总线仲裁

**关键代码修改点**：
- 修改`esp_spi_eth_new_w5500`函数，添加`card_index`参数
- 根据`card_index`选择不同的GPIO配置（CS、INT、RST、PHY地址）
- 修改`esp_bridge_eth_spi_init`函数，添加`card_index`参数
- 每个SPI总线独立初始化
- 每个设备使用独立的`eth_handle`

### 步骤3：创建双网卡网络接口
**目标**：在`bridge_common.c`的`esp_bridge_create_all_netif`中创建两个以太网接口

**实现内容**：
1. 创建W5500卡1的网络接口（自动WAN/LAN模式）：
   - 启用自动WAN/LAN切换功能
   - 根据连接设备自动判断角色
   - 连接路由器时作为WAN（DHCP客户端）
   - 连接下位设备时作为LAN（DHCP服务器）
   - 使用`esp_bridge_set_eth_wan_netif`和`esp_bridge_set_eth_lan_netif`管理
   - `if_key`动态变化："ETH_WAN"或"ETH_LAN"

2. 创建W5500卡2的网络接口（固定LAN模式）：
   - `data_forwarding = true`（固定作为数据转发接口）
   - `enable_dhcps = true`（始终启动DHCP服务器）
   - `route_prio = 10`（低优先级，作为LAN）
   - `if_key = "ETH_LAN2"`（固定）
   - 不参与自动WAN/LAN切换

3. 启用卡1的自动WAN/LAN切换：
   - 确保`CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN = y`
   - 卡1使用自动切换逻辑
   - 卡2使用固定LAN逻辑

4. 启用WiFi Station作为WAN接口：
   - 确保`CONFIG_BRIDGE_EXTERNAL_NETIF_STATION = y`
   - WiFi Station作为WAN接口使用

### 步骤4：实现网络状态监控
**目标**：监控卡1的网络连接状态，实现自动切换

**实现内容**：
1. 在`eth_event_handler`中添加链路状态监控：
   - 监听`ETHERNET_EVENT_CONNECTED`事件（卡1和卡2连接）
   - 监听`ETHERNET_EVENT_DISCONNECTED`事件（卡1和卡2断开）
   - 监听`IP_EVENT_ETH_GOT_IP`事件（卡1获取IP，作为WAN）
   - 监听`IP_EVENT_AP_STAIPASSIGNED`事件（卡1分配IP，作为LAN）
   - 监听`IP_EVENT_ETH_LOST_IP`事件（卡1丢失IP）

2. 在`wifi_event_sta_disconnected_handler`中添加WiFi Station状态监控：
   - 监听`WIFI_EVENT_STA_DISCONNECTED`事件（WiFi Station断开）
   - 监听`IP_EVENT_STA_GOT_IP`事件（WiFi Station获取IP）

3. 创建网络状态管理结构：
   - 记录卡1的连接状态
   - 记录卡1的角色（WAN或LAN）
   - 记录卡1的IP地址
   - 记录卡2的连接状态（固定LAN）
   - 记录WiFi Station的连接状态
   - 记录4G的连接状态

4. 实现路由优先级动态调整：
   - **卡1作为WAN时**：
     - 卡1连接且有IP：卡1路由优先级最高（route_prio = 50）
     - 卡1断开或无IP：降低卡1路由优先级，提升WiFi Station或4G路由优先级
   - **卡1作为LAN时**：
     - 4G路由优先级最高（route_prio = 50）
     - WiFi Station作为备用WAN
     - 卡1作为备用LAN接口

### 步骤5：实现智能路由切换
**目标**：根据网络状态自动切换路由

**实现内容**：
1. 创建路由切换函数：
   - `update_route_priority()`：根据网络状态更新路由优先级
   - `check_eth1_role()`：检查卡1当前角色（WAN或LAN）
   - `check_eth1_connectivity()`：检查卡1的网络连通性
   - `check_wifi_station_connectivity()`：检查WiFi Station的网络连通性

2. 实现路由切换逻辑：
   - **卡1作为WAN时**：
     - 卡1连接且有IP：优先使用卡1路由（route_prio = 50）
     - 卡1断开或无IP：切换到WiFi Station路由（route_prio = 45）
     - WiFi Station断开或无IP：切换到4G路由（route_prio = 40）
     - 卡2作为LAN（route_prio = 10）
   - **卡1作为LAN时**：
     - 4G路由优先级最高（route_prio = 50）
     - WiFi Station作为备用WAN（route_prio = 45）
     - 卡1作为LAN备用（route_prio = 10）
   - **角色切换时**：
     - 检测到卡1角色变化时，立即更新路由优先级
     - 更新DNS配置
     - 更新NAPT配置

3. 实现周期性检查：
   - 使用FreeRTOS定时器或任务定期检查网络状态
   - 检测间隔：5-10秒
   - 检查卡1角色变化
   - 检查各接口的连接状态

### 步骤6：配置DHCP服务器（卡2）
**目标**：确保卡2正确为下位计算机分配IP

**实现内容**：
1. 验证卡2的DHCP服务器配置：
   - IP地址池：例如192.168.4.2-192.168.4.254
   - 网关地址：卡2的IP地址
   - DNS服务器：根据当前WAN接口动态更新

2. 处理卡1作为LAN时的DHCP服务器：
   - 当卡1自动切换为LAN时，也会启动DHCP服务器
   - 需要确保卡1和卡2的IP地址池不冲突
   - 使用相同的网段（192.168.4.x）

3. 处理WiFi热点的DHCP服务器：
   - WiFi热点也会启动DHCP服务器
   - 需要确保WiFi热点、卡1作为LAN时和卡2的IP地址池不冲突
   - 使用相同的网段（192.168.4.x）

4. 更新DNS配置：
   - **卡1作为WAN时**：使用卡1获取的DNS
   - **WiFi Station作为WAN时**：使用WiFi Station获取的DNS
   - **卡1作为LAN时**：使用4G获取的DNS
   - 在`esp_bridge_update_dns_info`函数中根据当前WAN接口动态处理

### 步骤6.5：配置IP地址分配方案（共享LAN子网）
**目标**：配置卡1、卡2和WiFi热点共享同一个LAN子网（192.168.4.x），而卡1作为WAN时、WiFi Station和4G模块使用不同的子网（如192.168.1.x）。

**实现内容**：
1. **修改IP地址分配逻辑**：
   - 卡1作为WAN时：从上级路由器通过DHCP获取IP（如192.168.1.x网段）
   - WiFi Station作为WAN时：从上级路由器通过DHCP获取IP（如192.168.1.x网段）
   - 4G模块作为WAN时：从运营商通过DHCP获取IP（如10.x.x.x网段）
   - 卡1作为LAN时：使用192.168.4.1（与卡2和WiFi热点共享子网）
   - 卡2：固定使用192.168.4.1（与卡1作为LAN时和WiFi热点共享子网）
   - WiFi热点：使用192.168.4.1（与卡1作为LAN时和卡2共享子网）

2. **实现共享DHCP地址池**：
   - 卡1作为LAN、卡2和WiFi热点共享DHCP地址池（192.168.4.100-192.168.4.200）
   - 需要协调DHCP服务器，避免地址分配冲突

3. **修改相关代码**：
   - 在`bridge_common.c`中修改IP地址分配函数
   - 在`bridge_eth.c`中修改网络接口创建函数
   - 在`bridge_wifi.c`中修改WiFi接口创建函数

### 步骤7：配置自动WAN/LAN切换（仅卡1）
**目标**：确保卡1支持自动WAN/LAN切换，卡2固定为LAN，WiFi Station可作为WAN

**实现内容**：
1. 在`sdkconfig.defaults`中设置：
   - `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y`（启用自动切换）
   - `CONFIG_BRIDGE_EXTERNAL_NETIF_STATION=y`（启用WiFi Station作为WAN）
   - 卡1使用自动切换功能
   - 卡2不使用自动切换（固定LAN）

2. 在代码中实现差异化处理：
   - 卡1：使用`esp_bridge_set_eth_wan_netif`和`esp_bridge_set_eth_lan_netif`管理
   - 卡2：直接创建为固定LAN接口，不参与自动切换
   - WiFi Station：创建为WAN接口
   - 在`esp_bridge_create_eth_netif`函数中根据`card_index`区分处理

3. 添加配置验证：
   - 启动时检查配置
   - 确保卡1启用自动切换，卡2固定为LAN
   - 确保WiFi Station启用作为WAN
   - 验证IP地址池不冲突

---

## 七、测试计划

### 7.1 单元测试
- W5500卡2初始化测试
- 网络接口创建测试
- DHCP服务器测试
- 路由优先级测试

### 7.2 集成测试
- 双网卡同时工作测试
- 路由自动切换测试
- 4G转WiFi功能测试
- 下位计算机上网测试
- WiFi Station作为WAN测试

### 7.3 压力测试
- 长时间运行测试
- 频繁切换测试
- 多设备连接测试

## 八、风险评估

### 8.1 技术风险（分离SPI方案）

**优势**：
- ✅ **无SPI总线冲突**：两个W5500使用独立的SPI总线，无总线竞争问题
- ✅ **并行通信**：两个设备可以同时传输数据，性能优秀

**潜在风险**：
- **GPIO资源**：需要12个GPIO（每个SPI 6个）
  - **评估**：ESP32S3有约38个可用GPIO，资源充足 ✅
  - **缓解措施**：合理分配GPIO，避免与其他外设冲突

- **路由切换延迟**：自动切换可能导致短暂的网络中断
  - **缓解措施**：优化切换逻辑，减少延迟时间

- **内存占用**：双网卡可能增加内存占用
  - **评估**：内存充足，无需担心 ✅
  - **缓解措施**：优化内存使用，必要时增加系统内存配置

### 8.2 兼容性风险
- **原有功能影响**：修改可能影响4G转WiFi功能
  - **缓解措施**：充分测试原有功能，确保兼容性

## 九、时间估算

- **步骤1**：硬件配置扩展 - 2小时
- **步骤2**：扩展W5500初始化函数 - 4小时
- **步骤3**：创建双网卡网络接口 - 3小时
- **步骤4**：实现网络状态监控 - 4小时
- **步骤5**：实现智能路由切换 - 6小时
- **步骤6**：配置DHCP服务器 - 2小时
- **步骤6.5**：配置IP地址分配方案 - 3小时
- **步骤7**：配置自动WAN/LAN切换 - 2小时
- **步骤8**：集成测试和优化 - 8小时

**总计**：约34小时（不含调试时间）

## 十、后续优化建议

1. **配置界面**：添加Web配置界面，方便用户配置双网卡
2. **日志系统**：完善日志系统，方便问题排查
3. **监控功能**：添加网络流量监控功能
4. **负载均衡**：在多个WAN接口都可用时，实现负载均衡