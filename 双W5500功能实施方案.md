# 双W5500网卡功能实施方案

## 一、SPI方案选择

### 1.1 方案确定：共享SPI方案

**最终决定**：采用**共享SPI方案**

**硬件连接配置**：
- **卡1（W5500 Card 1）**：
  - SCK = GPIO9
  - MOSI = GPIO3
  - MISO = GPIO46
  - CS0 = GPIO10
  - INT = GPIO12
  - RESET = GPIO45

- **卡2（W5500 Card 2）**：
  - SCK = GPIO9（与卡1共享）
  - MOSI = GPIO3（与卡1共享）
  - MISO = GPIO46（与卡1共享）
  - CS0 = GPIO11（独立）
  - INT = GPIO13（独立）
  - RESET = GPIO34（独立）

**方案特点**：
- ✅ 两个W5500共享SPI总线（SCK、MOSI、MISO）
- ✅ 使用独立的CS信号区分设备
- ✅ 使用独立的INT和RST信号控制设备
- ✅ GPIO资源需求：9个（共享总线3个 + 独立控制6个）
- ✅ 软件需要实现总线仲裁机制（ESP-IDF SPI驱动自动处理）

### 1.2 性能预期

**共享SPI方案性能**：
- **总带宽**：30-50Mbps
- **延迟**：10-50ms（取决于负载）
- **并发能力**：受限（串行传输，ESP-IDF SPI驱动自动切换CS）
- **卡2转卡1性能**：串行传输，受SPI总线速度限制

**适用场景**：
- ✅ GPIO资源受限的情况
- ✅ 中等负载应用（5-10台设备）
- ✅ 对性能要求不极端苛刻的场景

---

## 二、需求分析

### 2.1 功能需求
1. **保留现有功能**：4G转WiFi功能保持不变
2. **新增W5500卡2**：
   - **采用方案**：与卡1共享SPI总线（SCK、MOSI、MISO），使用独立CS、INT、RST
   - **硬件连接**：
     - 共享总线：SCK=GPIO9, MOSI=GPIO3, MISO=GPIO46
     - 卡1独立：CS0=GPIO10, INT=GPIO12, RESET=GPIO45
     - 卡2独立：CS0=GPIO11, INT=GPIO13, RESET=GPIO34
3. **角色分配策略**：
   - **W5500卡1**：可WAN可LAN（自动切换）
     - 连接上级路由器时自动作为WAN
     - 连接下位设备时自动作为LAN
     - 启用"Ethernet acts as WAN or LAN automatically"功能
   - **W5500卡2**：固定作为LAN（连接下位计算机）
     - 始终作为数据转发接口
     - 始终启用DHCP服务器
     - 不参与自动切换
4. **智能路由切换**：
   - 当卡1作为WAN时：优先使用卡1有线网络，卡1断线时切换到4G
   - 当卡1作为LAN时：优先使用4G网络，4G断线时使用卡1
   - 卡2始终为下位计算机分配IP（DHCP服务器）

### 2.2 技术难点
1. **硬件层面**（共享SPI方案）：
   - 两个W5500共享SPI总线（SCK=GPIO9, MOSI=GPIO3, MISO=GPIO46）
   - 需要独立的CS片选信号区分设备（CS0=GPIO10, CS1=GPIO11）
   - 需要独立的INT中断信号（INT0=GPIO12, INT1=GPIO13）
   - 需要独立的RST复位信号（RST0=GPIO45, RST1=GPIO34）
   - ESP-IDF SPI驱动自动处理总线仲裁（通过CS信号切换）
   - **特点**：串行通信，性能受SPI总线速度限制，但实现简单

2. **软件层面**：
   - 需要创建两个独立的网络接口
   - 卡1需要支持自动WAN/LAN切换
   - 卡2固定为LAN模式
   - 需要实现路由优先级管理
   - 需要实现网络状态监控和动态切换
   - 需要实现DHCP服务器功能（卡2，以及卡1作为LAN时）

3. **路由层面**：
   - 动态路由优先级管理：
     - 卡1作为WAN时：卡1 > 4G > 卡2
     - 卡1作为LAN时：4G > 卡1 > 卡2
   - 实现链路状态检测
   - 实现路由表的动态更新
   - 处理卡1角色切换时的路由更新

## 三、代码结构分析

### 3.1 现有代码结构
- **bridge_eth.c**：以太网接口创建和管理
- **bridge_common.c**：网络接口通用管理，包括DHCP、DNS、路由等
- **bridge_spi.c**：SPI网络接口管理
- **bridge_modem.c**：4G模块管理
- **Kconfig**：配置文件，定义各种编译选项

### 3.2 关键配置项

**共享SPI方案配置**：
- `CONFIG_BRIDGE_ETH_SPI_HOST`：SPI主机（共享，例如SPI2或SPI3）
- `CONFIG_BRIDGE_ETH_SPI_SCLK_GPIO`：SCK引脚（共享，GPIO9）
- `CONFIG_BRIDGE_ETH_SPI_MOSI_GPIO`：MOSI引脚（共享，GPIO3）
- `CONFIG_BRIDGE_ETH_SPI_MISO_GPIO`：MISO引脚（共享，GPIO46）
- `CONFIG_BRIDGE_ETH_SPI_CS0_GPIO`：卡1的CS引脚（GPIO10）
- `CONFIG_BRIDGE_ETH_SPI_INT0_GPIO`：卡1的INT引脚（GPIO12）
- `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_GPIO`：卡1的RST引脚（GPIO45）
- `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0`：卡1的PHY地址（默认0）
- `CONFIG_BRIDGE_ETH_SPI_CS1_GPIO`：卡2的CS引脚（GPIO11）
- `CONFIG_BRIDGE_ETH_SPI_INT1_GPIO`：卡2的INT引脚（GPIO13）
- `CONFIG_BRIDGE_ETH_SPI_PHY_RST1_GPIO`：卡2的RST引脚（GPIO34）
- `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR1`：卡2的PHY地址（默认1）

**网络配置**：
- `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN`：自动WAN/LAN切换（卡1启用）
- `CONFIG_BRIDGE_EXTERNAL_NETIF_ETHERNET`：以太网作为WAN（可选，用于卡1）
- `CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET`：以太网作为LAN（卡2固定）

### 3.3 路由优先级
- WAN接口：`route_prio = 50`（较高优先级）
- LAN接口：`route_prio = 10`（较低优先级）
- 4G接口：需要查看具体配置

## 四、实施方案步骤

### 步骤1：硬件配置扩展（共享SPI方案）
**目标**：在Kconfig中添加W5500卡2的GPIO配置项（共享SPI总线）

**实现内容**（共享SPI方案）：
1. 在`Kconfig`中确认/修改卡1的SPI配置项（共享总线）：
   - `CONFIG_BRIDGE_ETH_SPI_HOST`：SPI主机（例如SPI2）
   - `CONFIG_BRIDGE_ETH_SPI_SCLK_GPIO`：SCK引脚（GPIO9，共享）
   - `CONFIG_BRIDGE_ETH_SPI_MOSI_GPIO`：MOSI引脚（GPIO3，共享）
   - `CONFIG_BRIDGE_ETH_SPI_MISO_GPIO`：MISO引脚（GPIO46，共享）
   - `CONFIG_BRIDGE_ETH_SPI_CS0_GPIO`：卡1的CS引脚（GPIO10）
   - `CONFIG_BRIDGE_ETH_SPI_INT0_GPIO`：卡1的INT引脚（GPIO12）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_RST0_GPIO`：卡1的RST引脚（GPIO45）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0`：卡1的PHY地址（默认0）

2. 在`Kconfig`中添加卡2的配置项（共享SPI总线）：
   - `CONFIG_BRIDGE_ETH_SPI_CS1_GPIO`：卡2的CS引脚（GPIO11）
   - `CONFIG_BRIDGE_ETH_SPI_INT1_GPIO`：卡2的INT引脚（GPIO13）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_RST1_GPIO`：卡2的RST引脚（GPIO34）
   - `CONFIG_BRIDGE_ETH_SPI_PHY_ADDR1`：卡2的PHY地址（默认1）

**检验步骤**（共享SPI方案）：
- 运行`idf.py menuconfig`，检查新配置项是否出现
- 验证卡1和卡2共享同一SPI总线（SCK、MOSI、MISO相同）
- 验证CS、INT、RST引脚配置正确：
  - 卡1：CS=GPIO10, INT=GPIO12, RST=GPIO45
  - 卡2：CS=GPIO11, INT=GPIO13, RST=GPIO34
- 验证配置项的值可以正确设置和保存
- 检查`sdkconfig`文件中是否包含新配置项

---

### 步骤2：扩展W5500初始化函数
**目标**：修改`bridge_eth.c`，支持初始化第二个W5500（共享SPI总线）

**实现内容**（共享SPI方案）：
1. 修改`esp_spi_eth_new_w5500`函数，支持设备索引参数（card_index）
2. 修改`esp_bridge_eth_spi_init`函数，支持初始化多个W5500设备（共享SPI总线）
3. 为每个W5500设备创建独立的`eth_handle`
4. 确保SPI总线只初始化一次（共享），但为每个设备创建独立的SPI设备配置（使用不同的CS）
5. ESP-IDF SPI驱动自动处理总线仲裁（通过CS信号切换）

**关键代码修改点**：
- 修改`esp_spi_eth_new_w5500`函数，添加`card_index`参数
- 根据`card_index`选择不同的GPIO配置（CS、INT、RST、PHY地址）
- 修改`esp_bridge_eth_spi_init`函数，添加`card_index`参数
- SPI总线只初始化一次，但为每个设备添加独立的SPI设备（使用不同的CS）
- 每个设备使用独立的`eth_handle`存储

**检验步骤**：
- 编译代码，确保没有编译错误
- 在启动日志中检查两个W5500是否都成功初始化
- 使用示波器或逻辑分析仪验证CS信号是否正确切换
- 检查INT和RST信号是否正确控制

---

### 步骤3：创建双网卡网络接口
**目标**：在`bridge_common.c`的`esp_bridge_create_all_netif`中创建两个以太网接口

**实现内容**：
1. 创建W5500卡1的网络接口（自动WAN/LAN模式）：
   - 启用自动WAN/LAN切换功能
   - 根据连接设备自动判断角色
   - 连接路由器时作为WAN（DHCP客户端）
   - 连接下位设备时作为LAN（DHCP服务器）
   - 使用`esp_bridge_set_eth_wan_netif`和`esp_bridge_set_eth_lan_netif`管理
   - `if_key`动态变化："ETH_WAN"或"ETH_LAN"

2. 创建W5500卡2的网络接口（固定LAN模式）：
   - `data_forwarding = true`（固定作为数据转发接口）
   - `enable_dhcps = true`（始终启动DHCP服务器）
   - `route_prio = 10`（低优先级，作为LAN）
   - `if_key = "ETH_LAN2"`（固定）
   - 不参与自动WAN/LAN切换

3. 启用卡1的自动WAN/LAN切换：
   - 确保`CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN = y`
   - 卡1使用自动切换逻辑
   - 卡2使用固定LAN逻辑

**检验步骤**：
- 检查网络接口是否成功创建
- 验证卡1配置为DHCP客户端（自动获取IP）
- 验证卡2配置为DHCP服务器（分配IP给下位机）
- 检查日志中是否有两个以太网接口的信息
- 使用`ip addr`或类似命令验证接口状态

---

### 步骤4：实现网络状态监控
**目标**：监控卡1的网络连接状态，实现自动切换

**实现内容**：
1. 在`eth_event_handler`中添加链路状态监控：
   - 监听`ETHERNET_EVENT_CONNECTED`事件（卡1和卡2连接）
   - 监听`ETHERNET_EVENT_DISCONNECTED`事件（卡1和卡2断开）
   - 监听`IP_EVENT_ETH_GOT_IP`事件（卡1获取IP，作为WAN）
   - 监听`IP_EVENT_AP_STAIPASSIGNED`事件（卡1分配IP，作为LAN）
   - 监听`IP_EVENT_ETH_LOST_IP`事件（卡1丢失IP）

2. 创建网络状态管理结构：
   - 记录卡1的连接状态
   - 记录卡1的角色（WAN或LAN）
   - 记录卡1的IP地址
   - 记录卡2的连接状态（固定LAN）
   - 记录4G的连接状态

3. 实现路由优先级动态调整：
   - **卡1作为WAN时**：
     - 卡1连接且有IP：卡1路由优先级最高（route_prio = 50）
     - 卡1断开或无IP：降低卡1路由优先级，提升4G路由优先级
   - **卡1作为LAN时**：
     - 4G路由优先级最高（route_prio = 50）
     - 卡1作为备用LAN接口

**检验步骤**：
- 连接卡1到路由器，检查是否正确获取IP
- 断开卡1网线，检查是否正确检测到断开
- 检查路由表，验证路由优先级是否正确
- 使用`ping`命令测试网络连通性

---

### 步骤5：实现智能路由切换
**目标**：根据卡1状态自动切换路由

**实现内容**：
1. 创建路由切换函数：
   - `update_route_priority()`：根据卡1角色和网络状态更新路由优先级
   - `check_eth1_role()`：检查卡1当前角色（WAN或LAN）
   - `check_eth1_connectivity()`：检查卡1的网络连通性

2. 实现路由切换逻辑：
   - **卡1作为WAN时**：
     - 卡1连接且有IP：优先使用卡1路由（route_prio = 50）
     - 卡1断开或无IP：切换到4G路由（route_prio = 40）
     - 卡2作为LAN（route_prio = 10）
   - **卡1作为LAN时**：
     - 4G路由优先级最高（route_prio = 50）
     - 卡1作为LAN备用（route_prio = 10）
     - 卡2作为LAN（route_prio = 10）
   - **角色切换时**：
     - 检测到卡1角色变化时，立即更新路由优先级
     - 更新DNS配置
     - 更新NAPT配置

3. 实现周期性检查：
   - 使用FreeRTOS定时器或任务定期检查网络状态
   - 检测间隔：5-10秒
   - 检查卡1角色变化
   - 检查各接口的连接状态

**检验步骤**：
- 连接卡1和4G，验证流量优先走卡1
- 断开卡1网线，验证流量自动切换到4G
- 重新连接卡1，验证流量自动切回卡1
- 使用`tcpdump`或类似工具监控数据包流向
- 测试卡1网线拔出和插入的场景

---

### 步骤6：配置DHCP服务器（卡2）
**目标**：确保卡2正确为下位计算机分配IP

**实现内容**：
1. 验证卡2的DHCP服务器配置：
   - IP地址池：例如192.168.4.2-192.168.4.254
   - 网关地址：卡2的IP地址
   - DNS服务器：根据当前WAN接口动态更新

2. 处理卡1作为LAN时的DHCP服务器：
   - 当卡1自动切换为LAN时，也会启动DHCP服务器
   - 需要确保卡1和卡2的IP地址池不冲突
   - 使用不同的网段（例如卡1：192.168.3.x，卡2：192.168.4.x）

3. 更新DNS配置：
   - **卡1作为WAN时**：使用卡1获取的DNS
   - **卡1作为LAN时**：使用4G获取的DNS
   - 在`esp_bridge_update_dns_info`函数中根据卡1角色动态处理

**检验步骤**：
- 将计算机连接到卡2
- 检查计算机是否自动获取IP地址
- 验证获取的IP地址在配置的地址池范围内
- 验证网关地址为卡2的IP地址
- 验证DNS服务器地址正确
- 测试计算机能否正常上网

---

### 步骤7：配置自动WAN/LAN切换（仅卡1）
**目标**：确保卡1支持自动WAN/LAN切换，卡2固定为LAN

**实现内容**：
1. 在`sdkconfig.defaults`中设置：
   - `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y`（启用自动切换）
   - 卡1使用自动切换功能
   - 卡2不使用自动切换（固定LAN）

2. 在代码中实现差异化处理：
   - 卡1：使用`esp_bridge_set_eth_wan_netif`和`esp_bridge_set_eth_lan_netif`管理
   - 卡2：直接创建为固定LAN接口，不参与自动切换
   - 在`esp_bridge_create_eth_netif`函数中根据`card_index`区分处理

3. 添加配置验证：
   - 启动时检查配置
   - 确保卡1启用自动切换，卡2固定为LAN
   - 验证IP地址池不冲突

**检验步骤**：
- 验证配置项已启用（仅对卡1）
- 检查代码中卡1使用自动切换逻辑，卡2使用固定LAN逻辑
- 测试卡1的角色是否能够自动切换：
  - 连接路由器时，卡1应自动变为WAN
  - 连接下位设备时，卡1应自动变为LAN
- 测试卡2的角色是否固定不变（始终为LAN）
- 验证IP地址池不冲突
- 验证路由优先级根据卡1角色正确更新

---

### 步骤8：集成测试和优化
**目标**：全面测试所有功能，优化性能

**实现内容**：
1. **功能测试**：
   - 测试4G转WiFi功能（确保原有功能正常）
   - 测试卡1作为WAN的功能
   - 测试卡2作为LAN的功能
   - 测试路由自动切换功能
   - 测试DHCP服务器功能

2. **稳定性测试**：
   - 长时间运行测试
   - 频繁插拔网线测试
   - 网络断线重连测试
   - 多设备连接测试

3. **性能优化**：
   - 优化路由切换速度
   - 优化SPI总线通信效率
   - 优化内存使用

**检验步骤**：
- 运行完整的功能测试套件
- 监控系统资源使用情况
- 测试各种异常场景
- 收集和分析日志
- 性能基准测试

---

## 四、关键代码修改点

### 4.1 Kconfig修改
```kconfig
# 添加卡2的GPIO配置
config BRIDGE_ETH_SPI_CS1_GPIO
    int "SPI CS1 GPIO number for SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 9  # 根据实际硬件设置
    help
        Set the GPIO number used by SPI CS1 for the second W5500.

config BRIDGE_ETH_SPI_INT1_GPIO
    int "Interrupt GPIO number SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 14  # 根据实际硬件设置
    help
        Set the GPIO number used by the second SPI Ethernet module interrupt line.

config BRIDGE_ETH_SPI_PHY_RST1_GPIO
    int "PHY Reset GPIO number of SPI Ethernet Module #2"
    range -1 BRIDGE_GPIO_RANGE_MAX
    default -1
    help
        Set the GPIO number used to reset PHY chip on the second SPI Ethernet module.
        Set to -1 to disable PHY chip hardware reset.

config BRIDGE_ETH_SPI_PHY_ADDR1
    int "PHY Address of SPI Ethernet Module #2"
    range 0 31
    default 1
    help
        Set the second SPI Ethernet module PHY address.
```

### 5.2 bridge_eth.c修改要点（分离SPI方案）
1. 修改`esp_spi_eth_new_w5500`函数，支持设备索引
2. 创建`esp_bridge_eth_spi_init_card2`函数，初始化卡2
3. 修改事件处理，区分卡1和卡2的事件
4. 创建独立的网络接口处理函数

### 5.3 bridge_common.c修改要点
1. 在`esp_bridge_create_all_netif`中添加卡2的接口创建
2. 修改DNS更新逻辑，支持双网卡场景
3. 添加路由优先级管理函数

## 六、测试计划

### 6.1 单元测试
- W5500卡2初始化测试
- 网络接口创建测试
- DHCP服务器测试
- 路由优先级测试

### 6.2 集成测试
- 双网卡同时工作测试
- 路由自动切换测试
- 4G转WiFi功能测试
- 下位计算机上网测试

### 6.3 压力测试
- 长时间运行测试
- 频繁切换测试
- 多设备连接测试

## 七、风险评估

### 7.1 技术风险（分离SPI方案）

**优势**：
- ✅ **无SPI总线冲突**：两个W5500使用独立的SPI总线，无总线竞争问题
- ✅ **并行通信**：两个设备可以同时传输数据，性能优秀

**潜在风险**：
- **GPIO资源**：需要12个GPIO（每个SPI 6个）
  - **评估**：ESP32S3有约38个可用GPIO，资源充足 ✅
  - **缓解措施**：合理分配GPIO，避免与其他外设冲突

- **路由切换延迟**：自动切换可能导致短暂的网络中断
  - **缓解措施**：优化切换逻辑，减少延迟时间

- **内存占用**：双网卡可能增加内存占用
  - **评估**：内存充足，无需担心 ✅
  - **缓解措施**：优化内存使用，必要时增加系统内存配置

### 7.1.1 技术风险（共享SPI方案，备选）

**潜在风险**：
- **SPI总线冲突**：两个W5500共享SPI总线可能导致通信冲突
  - **缓解措施**：使用独立的CS信号，确保同一时间只有一个设备访问总线
  - **缓解措施**：实现总线仲裁机制

- **性能受限**：总线共享导致性能受限
  - **缓解措施**：提高SPI时钟速度，优化DMA传输

- **软件复杂度**：需要实现总线仲裁机制
  - **缓解措施**：使用成熟的SPI多设备驱动库

### 7.2 兼容性风险
- **原有功能影响**：修改可能影响4G转WiFi功能
  - **缓解措施**：充分测试原有功能，确保兼容性

## 八、时间估算

- **步骤1**：硬件配置扩展 - 2小时
- **步骤2**：扩展W5500初始化函数 - 4小时
- **步骤3**：创建双网卡网络接口 - 3小时
- **步骤4**：实现网络状态监控 - 4小时
- **步骤5**：实现智能路由切换 - 6小时
- **步骤6**：配置DHCP服务器 - 2小时
- **步骤7**：禁用自动WAN/LAN切换 - 1小时
- **步骤8**：集成测试和优化 - 8小时

**总计**：约30小时（不含调试时间）

## 九、后续优化建议

1. **配置界面**：添加Web配置界面，方便用户配置双网卡
2. **日志系统**：完善日志系统，方便问题排查
3. **监控功能**：添加网络流量监控功能
4. **负载均衡**：在卡1和4G都可用时，实现负载均衡

