# 双W5500配置与测试指南

## 一、硬件配置指南

### 1.1 分离SPI方案硬件连接

**SPI2连接（W5500卡1）**：
```
ESP32S3          W5500卡1
--------         --------
GPIO9   ------>  SCK
GPIO3   ------>  MOSI
GPIO46  ------>  MISO
GPIO10  ------>  CS1
GPIO12  ------>  INT1
GPIO38  ------>  RST1
```

**SPI3连接（W5500卡2）**：
```
ESP32S3          W5500卡2
--------         --------
GPIO9   ------>  SCK
GPIO3   ------>  MOSI
GPIO46  ------>  MISO
GPIO11  ------>  CS2
GPIO13  ------>  INT2
GPIO34  ------>  RST2
```

### 1.2 Kconfig配置项

#### 1.2.1 分离SPI总线配置（卡1和卡2独立）

在`menuconfig`中配置：
```
Component config → Bridge Configuration → ETH Configuration
```

**卡1配置**：
- `SPI Host for W5500 Card1`：选择SPI2
- `SPI SCLK GPIO for Card1`：9
- `SPI MOSI GPIO for Card1`：3
- `SPI MISO GPIO for Card1`：46
- `SPI CS0 GPIO number for Card1`：10
- `Interrupt GPIO number SPI Ethernet module #1`：12
- `PHY Reset GPIO number of SPI Ethernet Module #1`：38
- `PHY Address of SPI Ethernet Module #1`：0（默认）

**卡2配置**：
- `SPI Host for W5500 Card2`：选择SPI2
- `SPI SCLK GPIO for Card2`：9
- `SPI MOSI GPIO for Card2`：3
- `SPI MISO GPIO for Card2`：46
- `SPI CS1 GPIO number for Card2`：11
- `Interrupt GPIO number SPI Ethernet module #2`：13
- `PHY Reset GPIO number of SPI Ethernet Module #2`：34
- `PHY Address of SPI Ethernet Module #2`：1（默认）

#### 1.2.2 共享SPI总线配置（卡1和卡2共享SPI总线，独立CS）

在`menuconfig`中配置：
```
Component config → Bridge Configuration → ETH Configuration
```

**添加卡2的配置项**：

```
# 双W5500配置（共享SPI总线，独立CS）
config BRIDGE_ETH_SPI_HOST
    int "SPI Host for W5500"
    range 1 3
    default 2
    help
        Select SPI host for W5500 (SPI2).

config BRIDGE_ETH_SPI_SCLK_GPIO
    int "SPI SCLK GPIO"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 9

config BRIDGE_ETH_SPI_MOSI_GPIO
    int "SPI MOSI GPIO"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 3

config BRIDGE_ETH_SPI_MISO_GPIO
    int "SPI MISO GPIO"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 46

config BRIDGE_ETH_SPI_CS0_GPIO
    int "SPI CS0 GPIO number for SPI Ethernet module #1"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 10

config BRIDGE_ETH_SPI_INT0_GPIO
    int "Interrupt GPIO number SPI Ethernet module #1"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 12

config BRIDGE_ETH_SPI_PHY_RST0_GPIO
    int "PHY Reset GPIO number of SPI Ethernet Module #1"
    range -1 BRIDGE_GPIO_RANGE_MAX
    default 38

config BRIDGE_ETH_SPI_PHY_ADDR0
    int "PHY Address of SPI Ethernet Module #1"
    range 0 31
    default 0

config BRIDGE_ETH_SPI_CS1_GPIO
    int "SPI CS1 GPIO number for SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 11

config BRIDGE_ETH_SPI_INT1_GPIO
    int "Interrupt GPIO number SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 13

config BRIDGE_ETH_SPI_PHY_RST1_GPIO
    int "PHY Reset GPIO number of SPI Ethernet Module #2"
    range -1 BRIDGE_GPIO_RANGE_MAX
    default 34

config BRIDGE_ETH_SPI_PHY_ADDR1
    int "PHY Address of SPI Ethernet Module #2"
    range 0 31
    default 1
```

### 1.3 配置验证

#### 1.3.1 使用menuconfig验证

```bash
idf.py menuconfig
```

导航到：`Component config → Bridge Configuration → ETH Configuration`

验证以下配置：
- ✅ 卡1配置：SPI2, SCK=GPIO12, MOSI=GPIO11, MISO=GPIO13, CS=GPIO10, INT=GPIO12, RST=GPIO38
- ✅ 卡2配置：SPI3, SCK=GPIO47, MOSI=GPIO21, MISO=GPIO19, CS=GPIO20, INT=GPIO14, RST=GPIO48

#### 1.3.2 检查sdkconfig文件

```bash
grep -E "BRIDGE_ETH_SPI_(HOST|SCLK|MOSI|MISO|CS[01]|INT[01]|PHY_RST[01]|PHY_ADDR[01])" sdkconfig
```

预期输出：
```
CONFIG_BRIDGE_ETH_SPI_HOST=2
CONFIG_BRIDGE_ETH_SPI_SCLK_GPIO=9
CONFIG_BRIDGE_ETH_SPI_MOSI_GPIO=3
CONFIG_BRIDGE_ETH_SPI_MISO_GPIO=46
CONFIG_BRIDGE_ETH_SPI_CS0_GPIO=10
CONFIG_BRIDGE_ETH_SPI_INT0_GPIO=12
CONFIG_BRIDGE_ETH_SPI_PHY_RST0_GPIO=38
CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0=0
CONFIG_BRIDGE_ETH_SPI_CS1_GPIO=11
CONFIG_BRIDGE_ETH_SPI_INT1_GPIO=13
CONFIG_BRIDGE_ETH_SPI_PHY_RST1_GPIO=34
CONFIG_BRIDGE_ETH_SPI_PHY_ADDR1=1
```

---

## 二、IP地址分配方案

### 2.1 目标
实现商用路由器功能，使WiFi热点、卡2和卡1（作为LAN时）共享同一个IP子网，而卡1（作为WAN时）、WiFi Station和4G模块使用不同的IP子网。

### 2.2 IP子网规划
- **WAN子网**：卡1作为WAN时、WiFi Station和4G模块使用各自获取的IP地址
- **LAN子网**：WiFi热点、卡2和卡1作为LAN时共享192.168.4.x子网

### 2.3 具体分配策略

#### WAN接口（动态IP）
- **卡1作为WAN**：从上级路由器通过DHCP获取IP（如192.168.1.x网段）
- **WiFi Station作为WAN**：从上级路由器通过DHCP获取IP（如192.168.1.x网段）
- **4G模块作为WAN**：从运营商通过DHCP获取IP（如10.x.x.x网段）

#### LAN接口（固定IP）
- **卡1作为LAN**：192.168.4.1
- **卡2**：192.168.4.1
- **WiFi热点**：192.168.4.1

### 2.4 DHCP地址池
- **共享地址池**：192.168.4.100-192.168.4.200
- **分配策略**：
  - 同一时间只有一个接口启用DHCP服务器功能
  - 卡1作为LAN时启用DHCP服务器
  - 卡2始终启用DHCP服务器
  - WiFi热点始终启用DHCP服务器
  - 通过协调机制避免地址冲突

---

## 三、实施步骤详细说明

### 步骤1：硬件配置扩展

#### 1.1 实现目标
在Kconfig配置系统中添加W5500卡2的GPIO配置项，支持独立配置卡2的CS、INT、RST引脚。

#### 1.2 具体实现
**文件**：`managed_components/espressif__iot_bridge/Kconfig`

**修改内容**（分离SPI方案）：

在`BRIDGE_USE_SPI_ETHERNET`配置块中，添加卡2的控制信号配置（分离SPI总线）：

**添加卡2的配置项**：

```
# 卡2控制信号配置（分离SPI总线）
config BRIDGE_ETH_SPI_HOST_CARD2
    int "SPI Host for W5500 Card2"
    range 1 3
    default 3
    help
        Select SPI host for W5500 Card2 (SPI3).

config BRIDGE_ETH_SPI_SCLK_CARD2_GPIO
    int "SPI SCLK GPIO for Card2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 47

config BRIDGE_ETH_SPI_MOSI_CARD2_GPIO
    int "SPI MOSI GPIO for Card2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 21

config BRIDGE_ETH_SPI_MISO_CARD2_GPIO
    int "SPI MISO GPIO for Card2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 19

config BRIDGE_ETH_SPI_CS0_CARD2_GPIO
    int "SPI CS0 GPIO number for SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 20

config BRIDGE_ETH_SPI_INT0_CARD2_GPIO
    int "Interrupt GPIO number SPI Ethernet module #2"
    range BRIDGE_GPIO_RANGE_MIN BRIDGE_GPIO_RANGE_MAX
    default 14

config BRIDGE_ETH_SPI_PHY_RST0_CARD2_GPIO
    int "PHY Reset GPIO number of SPI Ethernet Module #2"
    range -1 BRIDGE_GPIO_RANGE_MAX
    default 48

config BRIDGE_ETH_SPI_PHY_ADDR0_CARD2
    int "PHY Address of SPI Ethernet Module #2"
    range 0 31
    default 1
```

### 步骤2：扩展W5500初始化函数

#### 2.1 实现目标
修改`bridge_eth.c`，支持初始化第二个W5500设备（分离SPI总线方案）。

#### 2.2 具体实现（分离SPI方案）

**文件**：`managed_components/espressif__iot_bridge/src/bridge_eth.c`

**分离SPI方案实现**：

1. **修改`esp_spi_eth_new_w5500`函数，添加`card_index`参数**：
```c
#if CONFIG_ETH_SPI_ETHERNET_W5500
esp_err_t esp_spi_eth_new_w5500(spi_device_interface_config_t *spi_devcfg, 
                                 esp_netif_t *eth_netif_spi, 
                                 esp_eth_handle_t *eth_handle_spi,
                                 int card_index)  // 新增参数
{
    // ... 现有代码 ...
    
    // 根据card_index选择不同的GPIO
    if (card_index == 0) {
        w5500_config.int_gpio_num = CONFIG_BRIDGE_ETH_SPI_INT0_GPIO;
        phy_config_spi.phy_addr = CONFIG_BRIDGE_ETH_SPI_PHY_ADDR0;
        phy_config_spi.reset_gpio_num = CONFIG_BRIDGE_ETH_SPI_PHY_RST0_GPIO;
    } else if (card_index == 1) {
        w5500_config.int_gpio_num = CONFIG_BRIDGE_ETH_SPI_INT1_GPIO;
        phy_config_spi.phy_addr = CONFIG_BRIDGE_ETH_SPI_PHY_ADDR1;
        phy_config_spi.reset_gpio_num = CONFIG_BRIDGE_ETH_SPI_PHY_RST1_GPIO;
    }
    
    // ... 其余代码保持不变 ...
}
#endif
```

2. **修改SPI初始化函数，支持多个独立总线**：
```
esp_err_t esp_bridge_eth_spi_init(esp_netif_t* eth_netif_spi, int card_index)
{
    esp_err_t ret = ESP_FAIL;
    static bool eth_is_start_card1 = false;
    static bool eth_is_start_card2 = false;
    esp_eth_handle_t eth_handle_spi = NULL;
    
    // 使用相同的SPI主机（共享SPI总线）
    spi_host_device_t spi_host = CONFIG_BRIDGE_ETH_SPI_HOST;
    
    // 为共享SPI总线初始化（仅初始化一次）
    static bool spi_bus_initialized = false;
    if (!spi_bus_initialized) {
        spi_bus_config_t buscfg = {
            .miso_io_num = CONFIG_BRIDGE_ETH_SPI_MISO_GPIO,
            .mosi_io_num = CONFIG_BRIDGE_ETH_SPI_MOSI_GPIO,
            .sclk_io_num = CONFIG_BRIDGE_ETH_SPI_SCLK_GPIO,
            .quadwp_io_num = -1,
            .quadhd_io_num = -1,
        };
        
        // Install GPIO ISR handler
        gpio_install_isr_service(0);
        
        // Init SPI bus
        ESP_ERROR_CHECK(spi_bus_initialize(spi_host, &buscfg, SPI_DMA_CH_AUTO));
        spi_bus_initialized = true;
    }
    
    // 为每个设备创建独立的SPI设备配置
    spi_device_interface_config_t devcfg = {
        .mode = 0,
        .clock_speed_hz = CONFIG_BRIDGE_ETH_SPI_CLOCK_MHZ * 1000 * 1000,
        .queue_size = 20,
        .spics_io_num = (card_index == 0) ? CONFIG_BRIDGE_ETH_SPI_CS0_GPIO : CONFIG_BRIDGE_ETH_SPI_CS1_GPIO
    };
    
    // 初始化对应的W5500设备
    uint8_t spi_eth_module_max = sizeof(esp_bridge_spi_eth_module)/sizeof(esp_bridge_spi_eth_module[0]);
    for (uint8_t i = 0; i < spi_eth_module_max; i++) {
        if (esp_bridge_spi_eth_module[i](&devcfg, eth_netif_spi, &eth_handle_spi, card_index) == ESP_OK) {
            break;
        }
    }
    
    if (eth_handle_spi) {
        // 设置MAC地址（每个设备使用不同的MAC）
        uint8_t mac[6] = {0x02, 0x00, 0x00, 0x12, 0x34, 0x56 + card_index};
        ESP_ERROR_CHECK(esp_eth_ioctl(eth_handle_spi, ETH_CMD_S_MAC_ADDR, mac));
        
        // attach Ethernet driver to TCP/IP stack
        ESP_ERROR_CHECK(esp_netif_attach(eth_netif_spi, esp_eth_new_netif_glue(eth_handle_spi)));
    }
    
    ret = esp_eth_start(eth_handle_spi);
    
    if (card_index == 0) {
        eth_is_start_card1 = true;
    } else if (card_index == 1) {
        eth_is_start_card2 = true;
    }
    
    return ret;
}
```

### 步骤3：创建双网卡网络接口

#### 3.1 实现目标
在系统启动时创建两个独立的网络接口，卡1支持自动WAN/LAN切换，卡2固定为LAN。

#### 3.2 具体实现
**文件1**：`managed_components/espressif__iot_bridge/src/bridge_eth.c`

**修改`esp_bridge_create_eth_netif`函数**：
``c
esp_netif_t* esp_bridge_create_eth_netif(esp_netif_ip_info_t* ip_info, 
                                          uint8_t mac[6], 
                                          bool data_forwarding, 
                                          bool enable_dhcps,
                                          int card_index)  // 新增参数：0=卡1，1=卡2
{
    esp_netif_ip_info_t netif_ip_info = { 0 };
    esp_netif_inherent_config_t esp_netif_common_config = {
        .get_ip_event = IP_EVENT_ETH_GOT_IP,
#if ESP_IDF_VERSION >= ESP_IDF_VERSION_VAL(4, 4, 0)
        .lost_ip_event = IP_EVENT_ETH_LOST_IP,
#endif
        .if_key = "ETH_WAN",
        .if_desc = "eth",
        .flags = (esp_netif_flags_t)(ESP_NETIF_FLAG_GARP | ESP_NETIF_FLAG_EVENT_IP_MODIFIED),
        .route_prio = 50,
    };

    // 卡1：支持自动WAN/LAN切换
    // 卡2：固定为LAN
    if (card_index == 0) {
        // 卡1：启用自动WAN/LAN切换
        // 初始状态不设置data_forwarding，由自动切换逻辑决定
        // 使用默认配置，让自动切换逻辑处理
    } else if (card_index == 1) {
        // 卡2：固定为LAN
        esp_netif_common_config.flags |= ESP_NETIF_DHCP_SERVER;
        esp_netif_common_config.if_key = "ETH_LAN2";
        esp_netif_common_config.route_prio = 10;
        data_forwarding = true;
        enable_dhcps = true;
    }

    if (data_forwarding && card_index != 0) {
        // 卡2固定LAN模式
        esp_netif_common_config.flags |= ESP_NETIF_DHCP_SERVER;
        if (card_index == 1) {
            esp_netif_common_config.if_key = "ETH_LAN2";
        } else {
            esp_netif_common_config.if_key = "ETH_LAN";
        }
        esp_netif_common_config.route_prio = 10;
    } else if (!data_forwarding && card_index == 0) {
        // 卡1作为WAN（由自动切换逻辑管理）
        esp_netif_common_config.flags |= ESP_NETIF_DHCP_CLIENT;
        esp_netif_common_config.if_key = "ETH_WAN";
        esp_netif_common_config.route_prio = 50;
    }

    const esp_netif_driver_ifconfig_t eth_driver_ifconfig = {
        .driver_free_rx_buffer = eth_driver_free_rx_buffer,
        .transmit = eth_io_transmit,
        .transmit_wrap = eth_io_transmit_wrap,
        .handle = (card_index == 0) ? "ETH_CARD1" : "ETH_CARD2"  // 使用不同的handle区分
    };

    esp_bridge_eth_event_handler_register();

    esp_netif_config_t eth_config = ESP_NETIF_DEFAULT_ETH();
    eth_config.driver = &eth_driver_ifconfig;
    eth_config.base = &esp_netif_common_config;

    esp_netif_t* netif = esp_bridge_create_netif(&eth_config, ip_info, mac, enable_dhcps);
    if (netif) {
        // 卡1：使用自动WAN/LAN切换
        if (card_index == 0) {
#if defined(CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN)
            // 卡1启用自动切换，由esp_bridge_set_eth_wan_netif/esp_bridge_set_eth_lan_netif管理
            // 这里不设置固定角色，让自动切换逻辑处理
#endif
        } else {
            // 卡2：固定LAN，不使用自动切换
            // 直接配置为LAN模式
        }
        
        esp_netif_action_stop(netif, NULL, 0, NULL);
        #if CONFIG_BRIDGE_USE_INTERNAL_ETHERNET
        esp_bridge_eth_init(netif);
#elif CONFIG_BRIDGE_USE_SPI_ETHERNET
        // 分离SPI方案：根据card_index初始化不同的W5500设备
        esp_bridge_eth_spi_init(netif, card_index);
#endif
        esp_netif_up(netif);

        ESP_LOGI(TAG, "[%-12s] Card%d", esp_netif_get_ifkey(netif), card_index);

        if (data_forwarding) {
            esp_bridge_netif_list_add(netif, eth_netif_dhcp_status_change_cb);
            esp_netif_get_ip_info(netif, &netif_ip_info);
            ESP_LOGI(TAG, "ETH Card%d IP Address:" IPSTR, card_index, IP2STR(&netif_ip_info.ip));
            ip_napt_enable(netif_ip_info.ip.addr, 1);
        } else {
            esp_bridge_netif_list_add(netif, NULL);
        }

        if (enable_dhcps) {
            esp_netif_dhcps_start(netif);
        }
    }

    return netif;
}
```

**文件2**：`managed_components/espressif__iot_bridge/src/bridge_common.c`

**修改`esp_bridge_create_all_netif`函数**：
``c
void esp_bridge_create_all_netif(void)
{
    ESP_LOGI(TAG, "esp-iot-bridge version: %d.%d.%d", IOT_BRIDGE_VER_MAJOR, IOT_BRIDGE_VER_MINOR, IOT_BRIDGE_VER_PATCH);

    // ... 现有的WiFi、USB等接口创建代码 ...

    // 创建W5500卡1（支持自动WAN/LAN切换）
    #if defined(CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN)
        // 卡1使用自动切换功能，创建时不确定角色
        // 由自动切换逻辑根据连接设备决定
        esp_bridge_create_eth_netif(NULL, NULL, false, false, 0);  // card_index = 0
    #elif defined(CONFIG_BRIDGE_EXTERNAL_NETIF_ETHERNET)
        // 如果未启用自动切换，卡1作为WAN
        esp_bridge_create_eth_netif(NULL, NULL, false, false, 0);
    #endif

    // 创建W5500卡2（固定LAN模式）
    #if defined(CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET)
        // 卡2固定为LAN，始终启用DHCP服务器
        esp_bridge_create_eth_netif(NULL, NULL, true, true, 1);  // card_index = 1
    #endif

    // ... 4G模块等其余代码 ...
}
```

**文件3**：`sdkconfig.defaults`

**确保配置正确**：
``ini
# 启用自动WAN/LAN切换（仅用于卡1）
CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y

# 启用以太网接口
CONFIG_BRIDGE_ETHERNET_NETIF_ENABLE=y

# 卡2固定作为LAN
CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET=y

# 4G转WiFi保持不变
CONFIG_BRIDGE_EXTERNAL_NETIF_MODEM=y
CONFIG_BRIDGE_DATA_FORWARDING_NETIF_SOFTAP=y
```

---

## 四、检验步骤快速参考

### 步骤1：硬件配置扩展

#### ✅ 检验清单
- [ ] 运行 `idf.py menuconfig`
- [ ] 导航到 `Component config → Bridge Configuration → ETH Configuration`
- [ ] 验证以下配置项存在：
  - [ ] `SPI Host for W5500 Card2`
  - [ ] `SPI SCLK GPIO for Card2`
  - [ ] `SPI MOSI GPIO for Card2`
  - [ ] `SPI MISO GPIO for Card2`
  - [ ] `SPI CS0 GPIO number for SPI Ethernet module #2`
  - [ ] `Interrupt GPIO number SPI Ethernet module #2`
  - [ ] `PHY Reset GPIO number of SPI Ethernet Module #2`
  - [ ] `PHY Address of SPI Ethernet Module #2`
- [ ] 设置合适的GPIO引脚号（根据实际硬件）
- [ ] 保存配置
- [ ] 运行 `grep -E "BRIDGE_ETH_SPI_(HOST|SCLK|MOSI|MISO|CS0|INT0|PHY_RST0|PHY_ADDR0)_CARD[12]" sdkconfig`
- [ ] 验证配置项已保存
- [ ] 编译 `idf.py build`，检查无错误

### 步骤2：扩展W5500初始化函数

#### ✅ 检验清单（分离SPI方案）

- [ ] 编译代码 `idf.py build`
- [ ] 检查无编译错误
- [ ] 检查无类型不匹配警告
- [ ] 烧录到设备 `idf.py flash monitor`
- [ ] 查看串口日志，应该看到：
  - [ ] 两个SPI总线初始化信息（独立初始化）
  - [ ] "Ethernet Started" 消息出现两次（卡1和卡2）
  - [ ] 两个W5500的初始化信息
  - [ ] 无GPIO配置错误
- [ ] 使用示波器检查（可选）：
  - [ ] SPI总线信号：SCK=GPIO9, MOSI=GPIO3, MISO=GPIO46
  - [ ] CS0（GPIO10）和CS1（GPIO11）信号独立工作
  - [ ] INT0（GPIO12）和INT1（GPIO13）信号正确连接
  - [ ] RST0（GPIO38）和RST1（GPIO34）信号（如果启用）
- [ ] 功能验证：
  - [ ] 测试卡1和卡2是否可以同时工作
  - [ ] 验证数据通信是否正常
  - [ ] 测试卡2转卡1的数据转发功能

### 步骤3：创建双网卡网络接口

#### ✅ 检验清单
- [ ] 编译和烧录代码
- [ ] 查看串口日志，应该看到：
  - [ ] 两个以太网接口的创建信息
  - [ ] 卡1接口名称：`ETH_WAN` 或 `ETH_LAN`（根据连接设备自动切换）
  - [ ] 卡2接口名称：`ETH_LAN2`（固定）
  - [ ] 卡1显示为自动WAN/LAN切换模式
  - [ ] 卡2显示为固定LAN模式（DHCP服务器）
- [ ] 测试卡1自动切换：
  - [ ] 将卡1连接到路由器
  - [ ] 观察日志，应该看到卡1获取IP地址（WAN模式）
  - [ ] 记录卡1的IP地址和网关
  - [ ] 断开路由器，将下位设备连接到卡1
  - [ ] 观察日志，应该看到卡1分配IP地址（LAN模式）
- [ ] 检查卡2的IP配置：
  - [ ] 卡2应该有静态IP（例如192.168.4.1）
  - [ ] 日志中显示卡2的IP地址
- [ ] 将计算机连接到卡2：
  - [ ] 计算机应该自动获取IP地址
  - [ ] IP地址应该在192.168.4.x网段
  - [ ] 网关地址应该是卡2的IP地址
- [ ] 验证IP地址池不冲突：
  - [ ] 卡1作为LAN时的IP地址池（例如192.168.4.x）
  - [ ] 卡2的IP地址池（例如192.168.4.x）
  - [ ] 确保两个地址池使用相同网段（共享LAN子网）

### 步骤4：实现网络状态监控

#### ✅ 检验清单
- [ ] 编译和烧录代码
- [ ] 连接卡1到路由器，观察日志：
  - [ ] 应该看到 "W5500 Card1 Link Up"
  - [ ] 应该看到 "W5500 Card1 Got IP (WAN): x.x.x.x"
  - [ ] 应该看到 "W5500 Card1 Gateway: x.x.x.x"
  - [ ] 验证卡1角色为WAN
- [ ] 断开路由器，连接下位设备到卡1，观察日志：
  - [ ] 应该看到 "W5500 Card1 Assigned IP (LAN): x.x.x.x"
  - [ ] 验证卡1角色切换为LAN
- [ ] 断开卡1网线，观察日志：
  - [ ] 应该看到 "W5500 Card1 Link Down"
  - [ ] 应该看到 "W5500 Card1 Lost IP"
  - [ ] 验证卡1角色变为UNKNOWN
- [ ] 测试卡2连接，观察日志：
  - [ ] 应该看到 "W5500 Card2 Link Up"
  - [ ] 应该看到 "W5500 Card2 IP: x.x.x.x"
  - [ ] 验证卡2始终为LAN角色
- [ ] 添加状态输出日志（可选）：
  - [ ] 验证 `g_network_status` 结构体的值是否正确
  - [ ] 验证卡1角色变化（WAN/LAN/UNKNOWN）
  - [ ] 验证卡2角色固定（LAN）

### 步骤5：实现智能路由切换

#### ✅ 检验清单
- [ ] 测试场景1：卡1作为WAN
  - [ ] 将卡1连接到路由器，同时连接4G
  - [ ] 检查路由优先级：
    - [ ] 卡1(WAN)的优先级应该为50（高）
    - [ ] 4G的优先级应该为30（低）
    - [ ] 卡2(LAN)的优先级应该为10（最低）
    - [ ] 日志中应该显示 "Route priority: Card1(WAN) (50) > 4G (30) > Card2(LAN) (10)"
  - [ ] 测试流量路径：
    - [ ] 在下位计算机上执行 `traceroute 8.8.8.8`
    - [ ] 验证第一个跳点是卡1的网关
  - [ ] 断开卡1网线：
    - [ ] 日志中应该显示 "Route priority: 4G (50) > Card1(WAN) (10) > Card2(LAN) (10)"
    - [ ] 验证流量切换到4G
  - [ ] 重新连接卡1：
    - [ ] 日志中应该显示路由优先级切换回来
    - [ ] 验证流量切回卡1

- [ ] 测试场景2：卡1作为LAN
  - [ ] 断开路由器，将下位设备连接到卡1，同时连接4G
  - [ ] 检查路由优先级：
    - [ ] 4G的优先级应该为50（高）
    - [ ] 卡1(LAN)的优先级应该为10（低）
    - [ ] 卡2(LAN)的优先级应该为10（低）
    - [ ] 日志中应该显示 "Route priority: 4G (50) > Card1(LAN) (10) > Card2(LAN) (10)"
  - [ ] 测试流量路径：
    - [ ] 在下位计算机上执行 `traceroute 8.8.8.8`
    - [ ] 验证第一个跳点是4G的网关

- [ ] 测试场景3：卡1角色切换
  - [ ] 从WAN切换到LAN：断开路由器，连接下位设备
  - [ ] 验证路由优先级自动更新
  - [ ] 从LAN切换到WAN：断开下位设备，连接路由器
  - [ ] 验证路由优先级自动更新

- [ ] 测量切换延迟：
  - [ ] 角色切换时间应该在可接受范围内（<5秒）
  - [ ] 路由切换时间应该在可接受范围内（<5秒）

### 步骤6：配置DHCP服务器（卡2）

#### ✅ 检验清单
- [ ] 将计算机连接到卡2
- [ ] 检查计算机的网络配置：
  - [ ] 自动获取IP地址成功
  - [ ] IP地址在192.168.4.x网段
  - [ ] 网关地址为卡2的IP地址（例如192.168.4.1）
  - [ ] DNS服务器地址正确
- [ ] 测试DNS解析：
  - [ ] 在计算机上执行 `nslookup www.baidu.com`
  - [ ] 验证DNS解析正常
- [ ] 测试上网功能：
  - [ ] 在计算机上访问网页
  - [ ] 验证能够正常上网
- [ ] 测试路由优先级：
  - [ ] 连接卡1时，流量应该通过卡1
  - [ ] 断开卡1时，流量应该通过4G

### 步骤7：配置自动WAN/LAN切换（仅卡1）

#### ✅ 检验清单
- [ ] 检查配置文件：
  - [ ] `sdkconfig` 中 `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y`
  - [ ] `sdkconfig` 中 `CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET=y`
- [ ] 测试卡1自动切换：
  - [ ] 将卡1连接到路由器
  - [ ] 验证卡1自动变为WAN角色（日志中显示 "W5500 Card1 Got IP (WAN)"）
  - [ ] 断开路由器，将下位设备连接到卡1
  - [ ] 验证卡1自动变为LAN角色（日志中显示 "W5500 Card1 Assigned IP (LAN)"）
- [ ] 测试卡2固定LAN：
  - [ ] 连接卡2
  - [ ] 验证卡2始终为LAN角色（日志中显示 "W5500 Card2 IP"）
  - [ ] 验证卡2不会因为网络状态变化而改变角色
- [ ] IP地址池验证：
  - [ ] 验证卡1作为LAN时的IP地址池（例如192.168.4.x）
  - [ ] 验证卡2的IP地址池（例如192.168.4.x）
  - [ ] 确保两个地址池使用相同网段（共享LAN子网）
- [ ] 代码检查：
  - [ ] 搜索代码中 `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN` 的使用
  - [ ] 确保卡1使用自动切换逻辑
  - [ ] 确保卡2不使用自动切换逻辑

---

## 五、集成测试和优化

### 5.1 功能测试清单

#### 基础功能测试
- [ ] 4G转WiFi功能正常
  - [ ] 手机可以连接到WiFi热点
  - [ ] 手机可以正常上网
- [ ] 卡1作为WAN功能正常
  - [ ] 可以连接上级路由器
  - [ ] 可以获取IP地址
  - [ ] 可以访问互联网
- [ ] 卡2作为LAN功能正常
  - [ ] 可以为下位计算机分配IP
  - [ ] 下位计算机可以正常上网
- [ ] 下位计算机上网测试
  - [ ] 可以通过卡2访问互联网
  - [ ] 网页浏览正常
  - [ ] 下载文件正常

#### 路由切换测试
- [ ] 卡1连接时，流量优先走卡1
  - [ ] 使用 `traceroute` 验证
  - [ ] 使用流量监控工具验证
- [ ] 卡1断开时，流量自动切换到4G
  - [ ] 切换时间 < 5秒
  - [ ] 数据包丢失最少
- [ ] 卡1重新连接时，流量自动切回卡1
  - [ ] 切换时间 < 5秒
  - [ ] 数据包丢失最少
- [ ] 切换过程中数据包不丢失（或丢失最少）
  - [ ] 使用 `ping` 测试连续性
  - [ ] 使用下载测试验证

#### 稳定性测试
- [ ] 长时间运行测试（24小时）
  - [ ] 无异常重启
  - [ ] 网络连接稳定
  - [ ] 内存无泄漏
- [ ] 频繁插拔网线测试（100次）
  - [ ] 每次都能正确切换
  - [ ] 无系统崩溃
- [ ] 多设备连接测试（5台设备）
  - [ ] 所有设备都能正常获取IP
  - [ ] 所有设备都能正常上网
- [ ] 高负载测试（持续下载）
  - [ ] 系统稳定运行
  - [ ] 网络速度正常

#### 异常场景测试
- [ ] 卡1和4G同时断开
  - [ ] 系统不崩溃
  - [ ] 日志中显示错误信息
- [ ] 卡1连接但无互联网访问
  - [ ] 系统自动切换到4G
  - [ ] 切换时间正常
- [ ] 卡2连接多台设备
  - [ ] 所有设备都能正常获取IP
  - [ ] 所有设备都能正常上网
- [ ] 系统重启后配置保持
  - [ ] 重启后卡1和卡2的角色不变
  - [ ] 重启后网络配置正确

### 5.2 性能测试清单
- [ ] 路由切换时间测量
  - [ ] 卡1断开 -> 切换到4G：< 5秒
  - [ ] 4G断开 -> 切换到卡1：< 5秒
- [ ] 网络吞吐量测试
  - [ ] 卡1作为WAN时的速度
  - [ ] 4G作为WAN时的速度
- [ ] 内存使用测试
  - [ ] 空闲时内存使用
  - [ ] 高负载时内存使用
  - [ ] 长时间运行后内存使用
- [ ] CPU使用率测试
  - [ ] 空闲时CPU使用率
  - [ ] 高负载时CPU使用率

### 5.3 日志和调试清单
- [ ] 添加详细日志
  - [ ] 网络状态变化日志
  - [ ] 路由切换日志
  - [ ] 错误和警告日志
- [ ] 调试工具
  - [ ] 网络状态查询命令
  - [ ] 路由表查看命令
  - [ ] 性能统计命令

---

## 六、常见问题排查

### 问题1：两个W5500无法同时初始化
**可能原因**：
- SPI总线配置错误
- GPIO配置错误

**排查步骤**：
1. 检查SPI总线配置
2. 检查GPIO引脚配置
3. 检查日志中的错误信息

### 问题2：路由切换不工作
**可能原因**：
- 路由优先级设置错误
- 网络状态监控不工作
- 事件处理函数错误

**排查步骤**：
1. 检查路由优先级设置
2. 检查网络状态监控任务
3. 检查事件处理函数
4. 添加调试日志

### 问题3：DHCP服务器不工作
**可能原因**：
- DHCP服务器未启动
- IP地址池配置错误
- 网络接口配置错误

**排查步骤**：
1. 检查DHCP服务器是否启动
2. 检查IP地址池配置
3. 检查网络接口配置
4. 查看日志中的错误信息

### 问题4：4G转WiFi功能受影响
**可能原因**：
- 配置冲突
- 路由优先级设置错误
- 资源竞争

**排查步骤**：
1. 检查配置项
2. 检查路由优先级
3. 检查资源使用情况
4. 单独测试4G转WiFi功能

---

## 七、测试工具推荐

### 1. 网络测试工具
- **ping**：测试网络连通性
- **traceroute**：跟踪数据包路径
- **tcpdump**：抓包分析
- **iperf**：网络性能测试

### 2. 硬件测试工具
- **示波器**：检查信号
- **逻辑分析仪**：分析SPI通信
- **万用表**：测量电压

### 3. 日志分析工具
- **串口监视器**：查看实时日志
- **日志分析脚本**：分析日志文件
- **性能监控工具**：监控系统资源

---

## 八、完成标志

所有步骤完成后，应该满足以下条件：

1. ✅ 两个W5500网卡都能正常初始化
2. ✅ 卡1作为WAN，可以连接上级路由器
3. ✅ 卡2作为LAN，可以为下位计算机分配IP
4. ✅ 路由自动切换功能正常
5. ✅ 4G转WiFi功能正常
6. ✅ 所有测试用例通过
7. ✅ 系统稳定运行
8. ✅ 文档完整

---

## 九、下一步

完成所有步骤后，可以考虑：

1. **功能优化**：
   - 优化路由切换速度
   - 优化内存使用
   - 优化CPU使用率

2. **功能扩展**：
   - 添加Web配置界面
   - 添加网络流量监控
   - 添加负载均衡功能

3. **文档完善**：
   - 更新用户手册
   - 添加故障排除指南
   - 添加性能优化指南