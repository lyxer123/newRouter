# 双W5500功能实施检验步骤快速参考

## 步骤1：硬件配置扩展

### ✅ 检验清单
- [ ] 运行 `idf.py menuconfig`
- [ ] 导航到 `Component config → Bridge Configuration → ETH Configuration`
- [ ] 验证以下配置项存在：
  - [ ] `SPI CS1 GPIO number for SPI Ethernet module #2`
  - [ ] `Interrupt GPIO number SPI Ethernet module #2`
  - [ ] `PHY Reset GPIO number of SPI Ethernet Module #2`
  - [ ] `PHY Address of SPI Ethernet Module #2`
- [ ] 设置合适的GPIO引脚号（根据实际硬件）
- [ ] 保存配置
- [ ] 运行 `grep -E "BRIDGE_ETH_SPI_(CS1|INT1|PHY_RST1|PHY_ADDR1)" sdkconfig`
- [ ] 验证配置项已保存
- [ ] 编译 `idf.py build`，检查无错误

---

## 步骤2：扩展W5500初始化函数

### ✅ 检验清单（共享SPI方案）

- [ ] 编译代码 `idf.py build`
- [ ] 检查无编译错误
- [ ] 检查无类型不匹配警告
- [ ] 烧录到设备 `idf.py flash monitor`
- [ ] 查看串口日志，应该看到：
  - [ ] SPI总线初始化信息（只初始化一次）
  - [ ] "Ethernet Started" 消息出现两次（卡1和卡2）
  - [ ] 两个W5500的初始化信息
  - [ ] 无GPIO配置错误
- [ ] 使用示波器检查（可选）：
  - [ ] 共享SPI总线信号：SCK=GPIO9, MOSI=GPIO3, MISO=GPIO46
  - [ ] CS0（GPIO10）和CS1（GPIO11）信号正确切换
  - [ ] 验证同一时间只有一个CS信号有效（ESP-IDF SPI驱动自动切换）
  - [ ] INT0（GPIO12）和INT1（GPIO13）信号正确连接
  - [ ] RST0（GPIO45）和RST1（GPIO34）信号（如果启用）
- [ ] 功能验证：
  - [ ] 测试卡1和卡2是否可以同时工作
  - [ ] 验证数据通信是否正常
  - [ ] 测试卡2转卡1的数据转发功能

---

## 步骤3：创建双网卡网络接口

### ✅ 检验清单
- [ ] 编译和烧录代码
- [ ] 查看串口日志，应该看到：
  - [ ] 两个以太网接口的创建信息
  - [ ] 卡1接口名称：`ETH_WAN` 或 `ETH_LAN`（根据连接设备自动切换）
  - [ ] 卡2接口名称：`ETH_LAN2`（固定）
  - [ ] 卡1显示为自动WAN/LAN切换模式
  - [ ] 卡2显示为固定LAN模式（DHCP服务器）
- [ ] 测试卡1自动切换：
  - [ ] 将卡1连接到路由器
  - [ ] 观察日志，应该看到卡1获取IP地址（WAN模式）
  - [ ] 记录卡1的IP地址和网关
  - [ ] 断开路由器，将下位设备连接到卡1
  - [ ] 观察日志，应该看到卡1分配IP地址（LAN模式）
- [ ] 检查卡2的IP配置：
  - [ ] 卡2应该有静态IP（例如192.168.4.1）
  - [ ] 日志中显示卡2的IP地址
- [ ] 将计算机连接到卡2：
  - [ ] 计算机应该自动获取IP地址
  - [ ] IP地址应该在192.168.4.x网段
  - [ ] 网关地址应该是卡2的IP地址
- [ ] 验证IP地址池不冲突：
  - [ ] 卡1作为LAN时的IP地址池（例如192.168.3.x）
  - [ ] 卡2的IP地址池（例如192.168.4.x）
  - [ ] 确保两个地址池不冲突

---

## 步骤4：实现网络状态监控

### ✅ 检验清单
- [ ] 编译和烧录代码
- [ ] 连接卡1到路由器，观察日志：
  - [ ] 应该看到 "W5500 Card1 Link Up"
  - [ ] 应该看到 "W5500 Card1 Got IP (WAN): x.x.x.x"
  - [ ] 应该看到 "W5500 Card1 Gateway: x.x.x.x"
  - [ ] 验证卡1角色为WAN
- [ ] 断开路由器，连接下位设备到卡1，观察日志：
  - [ ] 应该看到 "W5500 Card1 Assigned IP (LAN): x.x.x.x"
  - [ ] 验证卡1角色切换为LAN
- [ ] 断开卡1网线，观察日志：
  - [ ] 应该看到 "W5500 Card1 Link Down"
  - [ ] 应该看到 "W5500 Card1 Lost IP"
  - [ ] 验证卡1角色变为UNKNOWN
- [ ] 测试卡2连接，观察日志：
  - [ ] 应该看到 "W5500 Card2 Link Up"
  - [ ] 应该看到 "W5500 Card2 IP: x.x.x.x"
  - [ ] 验证卡2始终为LAN角色
- [ ] 添加状态输出日志（可选）：
  - [ ] 验证 `g_network_status` 结构体的值是否正确
  - [ ] 验证卡1角色变化（WAN/LAN/UNKNOWN）
  - [ ] 验证卡2角色固定（LAN）

---

## 步骤5：实现智能路由切换

### ✅ 检验清单
- [ ] 测试场景1：卡1作为WAN
  - [ ] 将卡1连接到路由器，同时连接4G
  - [ ] 检查路由优先级：
    - [ ] 卡1(WAN)的优先级应该为50（高）
    - [ ] 4G的优先级应该为30（低）
    - [ ] 卡2(LAN)的优先级应该为10（最低）
    - [ ] 日志中应该显示 "Route priority: Card1(WAN) (50) > 4G (30) > Card2(LAN) (10)"
  - [ ] 测试流量路径：
    - [ ] 在下位计算机上执行 `traceroute 8.8.8.8`
    - [ ] 验证第一个跳点是卡1的网关
  - [ ] 断开卡1网线：
    - [ ] 日志中应该显示 "Route priority: 4G (50) > Card1(WAN) (10) > Card2(LAN) (10)"
    - [ ] 验证流量切换到4G
  - [ ] 重新连接卡1：
    - [ ] 日志中应该显示路由优先级切换回来
    - [ ] 验证流量切回卡1

- [ ] 测试场景2：卡1作为LAN
  - [ ] 断开路由器，将下位设备连接到卡1，同时连接4G
  - [ ] 检查路由优先级：
    - [ ] 4G的优先级应该为50（高）
    - [ ] 卡1(LAN)的优先级应该为10（低）
    - [ ] 卡2(LAN)的优先级应该为10（低）
    - [ ] 日志中应该显示 "Route priority: 4G (50) > Card1(LAN) (10) > Card2(LAN) (10)"
  - [ ] 测试流量路径：
    - [ ] 在下位计算机上执行 `traceroute 8.8.8.8`
    - [ ] 验证第一个跳点是4G的网关

- [ ] 测试场景3：卡1角色切换
  - [ ] 从WAN切换到LAN：断开路由器，连接下位设备
  - [ ] 验证路由优先级自动更新
  - [ ] 从LAN切换到WAN：断开下位设备，连接路由器
  - [ ] 验证路由优先级自动更新

- [ ] 测量切换延迟：
  - [ ] 角色切换时间应该在可接受范围内（<5秒）
  - [ ] 路由切换时间应该在可接受范围内（<5秒）

---

## 步骤6：配置DHCP服务器（卡2）

### ✅ 检验清单
- [ ] 将计算机连接到卡2
- [ ] 检查计算机的网络配置：
  - [ ] 自动获取IP地址成功
  - [ ] IP地址在192.168.4.x网段
  - [ ] 网关地址为卡2的IP地址（例如192.168.4.1）
  - [ ] DNS服务器地址正确
- [ ] 测试DNS解析：
  - [ ] 在计算机上执行 `nslookup www.baidu.com`
  - [ ] 验证DNS解析正常
- [ ] 测试上网功能：
  - [ ] 在计算机上访问网页
  - [ ] 验证能够正常上网
- [ ] 测试路由优先级：
  - [ ] 连接卡1时，流量应该通过卡1
  - [ ] 断开卡1时，流量应该通过4G

---

## 步骤7：配置自动WAN/LAN切换（仅卡1）

### ✅ 检验清单
- [ ] 检查配置文件：
  - [ ] `sdkconfig` 中 `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y`
  - [ ] `sdkconfig` 中 `CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET=y`
- [ ] 测试卡1自动切换：
  - [ ] 将卡1连接到路由器
  - [ ] 验证卡1自动变为WAN角色（日志中显示 "W5500 Card1 Got IP (WAN)"）
  - [ ] 断开路由器，将下位设备连接到卡1
  - [ ] 验证卡1自动变为LAN角色（日志中显示 "W5500 Card1 Assigned IP (LAN)"）
- [ ] 测试卡2固定LAN：
  - [ ] 连接卡2
  - [ ] 验证卡2始终为LAN角色（日志中显示 "W5500 Card2 IP"）
  - [ ] 验证卡2不会因为网络状态变化而改变角色
- [ ] IP地址池验证：
  - [ ] 验证卡1作为LAN时的IP地址池（例如192.168.3.x）
  - [ ] 验证卡2的IP地址池（例如192.168.4.x）
  - [ ] 确保两个地址池不冲突
- [ ] 代码检查：
  - [ ] 搜索代码中 `CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN` 的使用
  - [ ] 确保卡1使用自动切换逻辑
  - [ ] 确保卡2不使用自动切换逻辑

---

## 步骤8：集成测试和优化

### ✅ 功能测试清单

#### 基础功能测试
- [ ] 4G转WiFi功能正常
  - [ ] 手机可以连接到WiFi热点
  - [ ] 手机可以正常上网
- [ ] 卡1作为WAN功能正常
  - [ ] 可以连接上级路由器
  - [ ] 可以获取IP地址
  - [ ] 可以访问互联网
- [ ] 卡2作为LAN功能正常
  - [ ] 可以为下位计算机分配IP
  - [ ] 下位计算机可以正常上网
- [ ] 下位计算机上网测试
  - [ ] 可以通过卡2访问互联网
  - [ ] 网页浏览正常
  - [ ] 下载文件正常

#### 路由切换测试
- [ ] 卡1连接时，流量优先走卡1
  - [ ] 使用 `traceroute` 验证
  - [ ] 使用流量监控工具验证
- [ ] 卡1断开时，流量自动切换到4G
  - [ ] 切换时间 < 5秒
  - [ ] 数据包丢失最少
- [ ] 卡1重新连接时，流量自动切回卡1
  - [ ] 切换时间 < 5秒
  - [ ] 数据包丢失最少
- [ ] 切换过程中数据包不丢失（或丢失最少）
  - [ ] 使用 `ping` 测试连续性
  - [ ] 使用下载测试验证

#### 稳定性测试
- [ ] 长时间运行测试（24小时）
  - [ ] 无异常重启
  - [ ] 网络连接稳定
  - [ ] 内存无泄漏
- [ ] 频繁插拔网线测试（100次）
  - [ ] 每次都能正确切换
  - [ ] 无系统崩溃
- [ ] 多设备连接测试（5台设备）
  - [ ] 所有设备都能正常获取IP
  - [ ] 所有设备都能正常上网
- [ ] 高负载测试（持续下载）
  - [ ] 系统稳定运行
  - [ ] 网络速度正常

#### 异常场景测试
- [ ] 卡1和4G同时断开
  - [ ] 系统不崩溃
  - [ ] 日志中显示错误信息
- [ ] 卡1连接但无互联网访问
  - [ ] 系统自动切换到4G
  - [ ] 切换时间正常
- [ ] 卡2连接多台设备
  - [ ] 所有设备都能正常获取IP
  - [ ] 所有设备都能正常上网
- [ ] 系统重启后配置保持
  - [ ] 重启后卡1和卡2的角色不变
  - [ ] 重启后网络配置正确

### ✅ 性能测试清单
- [ ] 路由切换时间测量
  - [ ] 卡1断开 -> 切换到4G：< 5秒
  - [ ] 4G断开 -> 切换到卡1：< 5秒
- [ ] 网络吞吐量测试
  - [ ] 卡1作为WAN时的速度
  - [ ] 4G作为WAN时的速度
- [ ] 内存使用测试
  - [ ] 空闲时内存使用
  - [ ] 高负载时内存使用
  - [ ] 长时间运行后内存使用
- [ ] CPU使用率测试
  - [ ] 空闲时CPU使用率
  - [ ] 高负载时CPU使用率

### ✅ 日志和调试清单
- [ ] 添加详细日志
  - [ ] 网络状态变化日志
  - [ ] 路由切换日志
  - [ ] 错误和警告日志
- [ ] 调试工具
  - [ ] 网络状态查询命令
  - [ ] 路由表查看命令
  - [ ] 性能统计命令

---

## 常见问题排查

### 问题1：两个W5500无法同时初始化
**可能原因**：
- SPI总线配置错误
- CS信号冲突
- GPIO配置错误

**排查步骤**：
1. 检查SPI总线配置
2. 检查CS引脚配置
3. 使用示波器检查CS信号
4. 检查日志中的错误信息

### 问题2：路由切换不工作
**可能原因**：
- 路由优先级设置错误
- 网络状态监控不工作
- 事件处理函数错误

**排查步骤**：
1. 检查路由优先级设置
2. 检查网络状态监控任务
3. 检查事件处理函数
4. 添加调试日志

### 问题3：DHCP服务器不工作
**可能原因**：
- DHCP服务器未启动
- IP地址池配置错误
- 网络接口配置错误

**排查步骤**：
1. 检查DHCP服务器是否启动
2. 检查IP地址池配置
3. 检查网络接口配置
4. 查看日志中的错误信息

### 问题4：4G转WiFi功能受影响
**可能原因**：
- 配置冲突
- 路由优先级设置错误
- 资源竞争

**排查步骤**：
1. 检查配置项
2. 检查路由优先级
3. 检查资源使用情况
4. 单独测试4G转WiFi功能

---

## 测试工具推荐

### 1. 网络测试工具
- **ping**：测试网络连通性
- **traceroute**：跟踪数据包路径
- **tcpdump**：抓包分析
- **iperf**：网络性能测试

### 2. 硬件测试工具
- **示波器**：检查信号
- **逻辑分析仪**：分析SPI通信
- **万用表**：测量电压

### 3. 日志分析工具
- **串口监视器**：查看实时日志
- **日志分析脚本**：分析日志文件
- **性能监控工具**：监控系统资源

---

## 完成标志

所有步骤完成后，应该满足以下条件：

1. ✅ 两个W5500网卡都能正常初始化
2. ✅ 卡1作为WAN，可以连接上级路由器
3. ✅ 卡2作为LAN，可以为下位计算机分配IP
4. ✅ 路由自动切换功能正常
5. ✅ 4G转WiFi功能正常
6. ✅ 所有测试用例通过
7. ✅ 系统稳定运行
8. ✅ 文档完整

---

## 下一步

完成所有步骤后，可以考虑：

1. **功能优化**：
   - 优化路由切换速度
   - 优化内存使用
   - 优化CPU使用率

2. **功能扩展**：
   - 添加Web配置界面
   - 添加网络流量监控
   - 添加负载均衡功能

3. **文档完善**：
   - 更新用户手册
   - 添加故障排除指南
   - 添加性能优化指南

