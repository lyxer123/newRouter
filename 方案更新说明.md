# 双W5500方案更新说明

## 更新内容

根据新的需求，方案已从**固定角色分配**更新为**卡1可WAN可LAN，卡2固定LAN**。

## 主要变更

### 1. 角色分配策略变更

**原方案**：
- 卡1：固定为WAN
- 卡2：固定为LAN
- 禁用自动WAN/LAN切换功能

**新方案**：
- **卡1**：可WAN可LAN（自动切换）
  - 连接上级路由器时自动作为WAN
  - 连接下位设备时自动作为LAN
  - 启用"Ethernet acts as WAN or LAN automatically"功能
- **卡2**：固定为LAN（连接下位计算机）
  - 始终作为数据转发接口
  - 始终启用DHCP服务器
  - 不参与自动切换

### 2. 路由优先级策略变更

**原方案**：
- 卡1作为WAN时：卡1 > 4G > 卡2

**新方案**：
- **卡1作为WAN时**：卡1(WAN) > 4G > 卡2(LAN)
- **卡1作为LAN时**：4G > 卡1(LAN) > 卡2(LAN)

### 3. 配置变更

**原配置**：
```ini
CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=n  # 禁用
CONFIG_BRIDGE_EXTERNAL_NETIF_ETHERNET=y         # 卡1作为WAN
CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET=y  # 卡2作为LAN
```

**新配置**：
```ini
CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN=y  # 启用（仅用于卡1）
CONFIG_BRIDGE_DATA_FORWARDING_NETIF_ETHERNET=y  # 卡2固定作为LAN
```

### 4. 代码实现变更

#### 4.1 网络接口创建

**变更点**：
- 卡1：使用自动WAN/LAN切换逻辑
- 卡2：固定创建为LAN接口，不使用自动切换

**关键代码**：
```c
// 卡1：启用自动切换
#if defined(CONFIG_BRIDGE_NETIF_ETHERNET_AUTO_WAN_OR_LAN)
    // 卡1使用自动切换，由esp_bridge_set_eth_wan_netif/esp_bridge_set_eth_lan_netif管理
#endif

// 卡2：固定LAN
esp_bridge_create_eth_netif(NULL, NULL, true, true, 1);  // card_index = 1
```

#### 4.2 网络状态监控

**变更点**：
- 需要监控卡1的角色变化（WAN/LAN）
- 需要处理卡1角色切换时的路由更新

**关键代码**：
```c
typedef enum {
    ETH_ROLE_UNKNOWN = 0,
    ETH_ROLE_WAN,
    ETH_ROLE_LAN
} eth_role_t;

// 监听IP_EVENT_ETH_GOT_IP（卡1作为WAN）
// 监听IP_EVENT_AP_STAIPASSIGNED（卡1作为LAN）
```

#### 4.3 路由优先级管理

**变更点**：
- 根据卡1的角色动态调整路由优先级
- 卡1作为WAN时，卡1优先级最高
- 卡1作为LAN时，4G优先级最高

**关键代码**：
```c
if (g_network_status.card1_role == ETH_ROLE_WAN) {
    // 卡1作为WAN：卡1 > 4G > 卡2
    esp_netif_set_route_prio(eth_wan_netif, 50);
    esp_netif_set_route_prio(modem_netif, 30);
} else if (g_network_status.card1_role == ETH_ROLE_LAN) {
    // 卡1作为LAN：4G > 卡1 > 卡2
    esp_netif_set_route_prio(modem_netif, 50);
    esp_netif_set_route_prio(eth_lan_netif, 10);
}
```

#### 4.4 DHCP服务器配置

**变更点**：
- 卡1作为LAN时，也会启动DHCP服务器
- 需要确保卡1和卡2的IP地址池不冲突

**关键配置**：
- 卡1作为LAN时：192.168.3.x
- 卡2固定LAN：192.168.4.x

## 更新的文档

以下文档已根据新需求更新：

1. **双W5500功能实施方案.md**
   - 更新需求分析
   - 更新技术难点
   - 更新实施步骤
   - 更新路由优先级策略

2. **实施步骤详细说明.md**
   - 更新步骤3：创建双网卡网络接口
   - 更新步骤4：实现网络状态监控
   - 更新步骤5：实现智能路由切换
   - 更新步骤6：配置DHCP服务器
   - 更新步骤7：配置自动WAN/LAN切换

3. **检验步骤快速参考.md**
   - 更新步骤3-7的检验清单
   - 增加卡1角色切换的测试场景
   - 增加IP地址池冲突验证

## 功能优势

### 1. 更灵活的使用场景

- **场景1**：卡1连接路由器（WAN），卡2连接下位设备（LAN）
  - 优先使用卡1有线网络
  - 卡1断线时自动切换到4G

- **场景2**：卡1连接下位设备（LAN），卡2连接下位设备（LAN）
  - 优先使用4G网络
  - 两个LAN接口可以同时为下位设备提供服务

### 2. 自动适应连接

- 卡1可以根据连接设备自动判断角色
- 无需手动配置
- 更加智能和便捷

### 3. 更好的容错性

- 卡1可以在WAN和LAN之间切换
- 适应不同的网络环境
- 提高系统的适应性

## 注意事项

### 1. IP地址池管理

- 需要确保卡1和卡2的IP地址池不冲突
- 建议使用不同的网段（例如192.168.3.x和192.168.4.x）

### 2. 路由优先级

- 卡1角色变化时，需要及时更新路由优先级
- 确保路由切换的及时性和准确性

### 3. DHCP服务器

- 卡1作为LAN时，也会启动DHCP服务器
- 需要管理两个DHCP服务器的配置
- 确保DNS配置正确更新

### 4. 测试验证

- 需要测试卡1角色切换的各种场景
- 验证路由优先级更新是否正确
- 验证IP地址池不冲突

## 实施建议

1. **分步实施**：
   - 先实现卡1的自动WAN/LAN切换
   - 再实现卡2的固定LAN
   - 最后实现路由优先级动态调整

2. **充分测试**：
   - 测试卡1角色切换的各种场景
   - 测试路由优先级更新
   - 测试IP地址池管理

3. **日志监控**：
   - 添加详细的日志输出
   - 监控卡1角色变化
   - 监控路由优先级更新

## 总结

新方案提供了更灵活的网络配置，卡1可以根据连接设备自动切换角色，卡2固定为LAN。这样的设计可以适应更多的使用场景，提高系统的灵活性和适应性。

实施时需要注意IP地址池管理、路由优先级更新、DHCP服务器配置等方面，确保系统稳定运行。

